<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Editor con dphysicsengine + Monaco + Pyodide</title>

<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    display: flex; flex-direction: row; font-family: sans-serif;
  }
  #editor {
    width: 50vw; height: 100vh;
  }
  #right-panel {
    width: 50vw; height: 100vh;
    display: flex; flex-direction: column;
    align-items: center; justify-content: flex-start;
    padding: 10px;
    box-sizing: border-box;
  }
  #canvas {
    border: 1px solid #aaa;
    width: 800px; height: 600px;
  }
  #buttons {
    margin: 10px 0;
  }
</style>

<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

<!-- Monaco loader -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/loader.js"></script>
</head>
<body>

<div id="editor"></div>

<div id="right-panel">
  <div id="buttons">
    <button id="run-btn">Run</button>
    <button id="stop-btn">Stop</button>
  </div>
  <canvas id="canvas" width="800" height="600"></canvas>
  <div id="status">Status: <span id="status-text">Idle</span></div>
</div>
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>


<script>
  // Cargar Monaco Editor
  require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs' }});
  let editor;
  require(['vs/editor/editor.main'], function() {
    editor = monaco.editor.create(document.getElementById('editor'), {
      value: `# Escribe tu código aquí

from dphysicsengine import World, Ball, Vector

world = World(800, 600)

# Añadir una bola
ball = Ball(position=Vector(100, 100), radius=20, mass=10)
world.add_object(ball)

t = 0

def setup():
    global t
    t = 0

def step(dt):
    global t
    t += dt
    world.update(dt)

def draw(ctx):
    ctx.clearRect(0, 0, 800, 600)
    for obj in world.get_objects():
        obj.draw(ctx)
`,
      language: 'python',
      theme: 'vs-light',
      automaticLayout: true,
    });
  });

  // Pyodide setup
  let pyodide = null;
  let running = false;
  let intervalId = null;

  async function loadPyodideAndPackages() {
    document.getElementById('status-text').textContent = 'Loading Pyodide...';
    pyodide = await loadPyodide({
      indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/",
    });
    document.getElementById('status-text').textContent = 'Installing dphysicsengine...';
    await pyodide.loadPackage("micropip");
    // await pyodide.runPythonAsync(`
    //   import micropip
    //   await micropip.install('dphysicsengine')
    // `);
    // document.getElementById('status-text').textContent = 'Ready';
  }


  // Ejecutar código del editor con la simulación
  async function runCode() {
    if (!pyodide) {
      await loadPyodideAndPackages();
    }
    document.getElementById('status-text').textContent = 'Running simulation';
    try {
      const code = editor.getValue();
      // Define funciones globales para step y draw, que usaremos desde JS
      await pyodide.runPythonAsync(code);
      // Obtener referencias a las funciones Python
      const setup = pyodide.globals.get('setup');
      const step = pyodide.globals.get('step');
      const draw = pyodide.globals.get('draw');

      // Inicializar la simulación
      setup();

      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const FPS = 60;
      const DT = 1 / FPS;

      running = true;
      let lastTime = performance.now();

      function loop(time) {
        if (!running) return;
        const delta = (time - lastTime) / 1000;
        lastTime = time;

        step(DT);

        // Limpiar y dibujar
        draw(ctx);

        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);

    } catch (e) {
      document.getElementById('status-text').textContent = 'Error: ' + e;
      running = false;
    }
  }

  function stopSimulation() {
    running = false;
    document.getElementById('status-text').textContent = 'Stopped';
  }

  document.getElementById('run-btn').addEventListener('click', () => {
    if (!running) runCode();
  });
  document.getElementById('stop-btn').addEventListener('click', () => {
    stopSimulation();
  });
</script>

<!-- Pyodide loader -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
</body>
</html>
