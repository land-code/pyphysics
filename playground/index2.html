<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Motor físico en Pyodide + Canvas</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <style>
    body { font-family: sans-serif; }
    #code { width: 100%; height: 250px; font-family: monospace; font-size: 14px; }
    #canvas { border: 1px solid black; }
  </style>
</head>
<body>
  <h2>Editor Python</h2>
  <textarea id="code">
# Motor físico básico: bola cayendo y rebotando

from js import document
import asyncio

canvas = document.getElementById("canvas")
ctx = canvas.getContext("2d")

# Estado de la bola
ball = {
    "x": 100,
    "y": 50,
    "vx": 0,
    "vy": 0,
    "radius": 20,
    "mass": 1,
    "restitution": 0.8
}

gravity = 980  # px/s²
dt = 1/60  # segundos por frame

def clear():
    ctx.fillStyle = "white"
    ctx.fillRect(0, 0, canvas.width, canvas.height)

def draw_ball():
    ctx.beginPath()
    ctx.fillStyle = "red"
    ctx.arc(ball["x"], ball["y"], ball["radius"], 0, 6.28)
    ctx.fill()

def update():
    # Física simple
    ball["vy"] += gravity * dt
    ball["x"] += ball["vx"] * dt
    ball["y"] += ball["vy"] * dt

    # Colisión con suelo
    floor = canvas.height - ball["radius"]
    if ball["y"] > floor:
        ball["y"] = floor
        ball["vy"] = -ball["vy"] * ball["restitution"]

async def main_loop():
    while True:
        clear()
        update()
        draw_ball()
        await asyncio.sleep(dt)

async def run():
    # Arranca el loop asincrónico
    await main_loop()
  </textarea>
  <br/>
  <button id="run-btn">Ejecutar</button>
  <br/><br/>
  <canvas id="canvas" width="600" height="400"></canvas>

  <script>
    let pyodide = null;
    let runTask = null;

    async function loadPyodideAndPackages() {
      pyodide = await loadPyodide();
      console.log("Pyodide cargado");
    }

    async function runPythonCode() {
      if (runTask) {
        // Si ya hay una simulación en marcha, cancelarla reiniciando la página (simple)
        alert("Recarga la página para reiniciar la simulación");
        return;
      }
      let code = document.getElementById("code").value;
      try {
        // Ejecutar código y arrancar loop async
        runTask = pyodide.runPythonAsync(code + "\nimport asyncio\nasyncio.create_task(run())");
        await runTask;
      } catch (err) {
        alert("Error en Python: " + err);
      }
    }

    document.getElementById("run-btn").addEventListener("click", runPythonCode);

    loadPyodideAndPackages();
  </script>
</body>
</html>
